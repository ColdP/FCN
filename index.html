<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即时聊天</title>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            setPersistence,
            browserSessionPersistence,
            browserLocalPersistence,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            query, 
            where, 
            getDocs,
            onSnapshot,
            addDoc,
            serverTimestamp,
            orderBy
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // 您的 Firebase 配置信息
        const firebaseConfig = {
            apiKey: "AIzaSyD7RPa3sBP4p2hFqLQh_RVxunaFEsYzSi8",
            authDomain: "friend-chat-network.firebaseapp.com",
            projectId: "friend-chat-network",
            storageBucket: "friend-chat-network.firebasestorage.app",
            messagingSenderId: "485132197819",
            appId: "1:485132197819:web:d4f5142061bab8325cee9e",
            measurementId: "G-PEZ2E315ZT"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 将核心变量挂载到 window 对象，以便在 HTML 事件处理程序中访问
        window.firebase = {
            auth,
            db,
            onAuthStateChanged,
            setPersistence,
            browserSessionPersistence,
            browserLocalPersistence,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail,
            doc,
            setDoc,
            getDoc,
            collection,
            query,
            where,
            getDocs,
            onSnapshot,
            addDoc,
            serverTimestamp,
            orderBy
        };
    </script>

    <style>
        /* Material 3 Expressive 主题颜色和字体 */
        :root {
            --md-sys-color-primary: #6D28D9; /* Deep Purple */
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #9333EA; /* Bright Purple */
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #F3E8FF;
            --md-sys-color-on-secondary-container: #251431;
            --md-sys-color-tertiary: #DB2777; /* Pink */
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #3E001E;
            --md-sys-color-error: #B3261E;
            --md-sys-color-background: #FEF7FF;
            --md-sys-color-on-background: #1D1B20;
            --md-sys-color-surface: #FEF7FF;
            --md-sys-color-on-surface: #1D1B20;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-surface-container-highest: #E6E0E9;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--md-sys-color-surface-variant);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--md-sys-color-primary);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--md-sys-color-secondary);
        }

        /* 界面切换动画 */
        .view {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 移动端响应式：聊天界面 */
        @media (max-width: 768px) {
            #chat-view .chat-sidebar {
                position: absolute;
                left: -100%;
                transition: left 0.3s ease-in-out;
                z-index: 40;
                height: 100%;
            }
            #chat-view .chat-sidebar.open {
                left: 0;
            }
            #chat-view .chat-main {
                width: 100%;
            }
            #chat-overlay {
                display: none;
            }
            #chat-overlay.open {
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 30;
            }
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden">

    <!-- 加载指示器 -->
    <div id="loader" class="fixed inset-0 bg-white/80 z-[999] flex items-center justify-center backdrop-blur-sm">
        <div class="flex flex-col items-center gap-4">
            <svg class="animate-spin h-10 w-10 text-[var(--md-sys-color-primary)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-medium text-[var(--md-sys-color-on-background)]">加载中...</p>
        </div>
    </div>

    <!-- 登录视图 -->
    <div id="login-view" class="view h-full w-full flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-[var(--md-sys-color-surface)] p-8 rounded-3xl shadow-2xl space-y-6">
            <div class="text-center">
                <span class="material-symbols-outlined text-6xl text-[var(--md-sys-color-primary)]">chat_bubble</span>
                <h1 class="text-3xl font-bold text-[var(--md-sys-color-on-surface)] mt-2">欢迎回来</h1>
                <p class="text-[var(--md-sys-color-on-surface-variant)]">登录以继续您的聊天</p>
            </div>
            <div id="login-error" class="hidden text-red-500 bg-red-100 p-3 rounded-lg text-sm"></div>
            <div class="space-y-4">
                <input id="login-email" type="email" placeholder="邮箱" class="w-full px-4 py-3 bg-[var(--md-sys-color-surface-container-highest)] rounded-xl border-2 border-transparent focus:border-[var(--md-sys-color-primary)] focus:outline-none transition">
                <input id="login-password" type="password" placeholder="密码" class="w-full px-4 py-3 bg-[var(--md-sys-color-surface-container-highest)] rounded-xl border-2 border-transparent focus:border-[var(--md-sys-color-primary)] focus:outline-none transition">
            </div>
            <div class="flex items-center justify-between text-sm">
                <label class="flex items-center gap-2 text-[var(--md-sys-color-on-surface-variant)] cursor-pointer">
                    <input id="remember-me" type="checkbox" class="rounded text-[var(--md-sys-color-primary)] focus:ring-[var(--md-sys-color-primary)]">
                    记住我
                </label>
                <a href="#" onclick="showView('forgot-password-view')" class="font-medium text-[var(--md-sys-color-primary)] hover:text-[var(--md-sys-color-secondary)]">忘记密码?</a>
            </div>
            <div>
                <button onclick="handleLogin()" class="w-full bg-[var(--md-sys-color-primary)] text-[var(--md-sys-color-on-primary)] py-3 rounded-full font-bold text-lg shadow-lg hover:bg-[var(--md-sys-color-secondary)] transition-transform transform hover:scale-105">
                    登录
                </button>
            </div>
            <p class="text-center text-sm text-[var(--md-sys-color-on-surface-variant)]">
                还没有账户? <a href="#" onclick="showView('register-view')" class="font-medium text-[var(--md-sys-color-primary)] hover:text-[var(--md-sys-color-secondary)]">立即注册</a>
            </p>
        </div>
    </div>

    <!-- 注册视图 -->
    <div id="register-view" class="view h-full w-full flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-[var(--md-sys-color-surface)] p-8 rounded-3xl shadow-2xl space-y-6">
            <div class="text-center">
                <span class="material-symbols-outlined text-6xl text-[var(--md-sys-color-tertiary)]">person_add</span>
                <h1 class="text-3xl font-bold text-[var(--md-sys-color-on-surface)] mt-2">创建账户</h1>
                <p class="text-[var(--md-sys-color-on-surface-variant)]">加入我们，开始聊天吧！</p>
            </div>
            <div id="register-error" class="hidden text-red-500 bg-red-100 p-3 rounded-lg text-sm"></div>
            <div class="space-y-4">
                <input id="register-username" type="text" placeholder="用户名" class="w-full px-4 py-3 bg-[var(--md-sys-color-surface-container-highest)] rounded-xl border-2 border-transparent focus:border-[var(--md-sys-color-tertiary)] focus:outline-none transition">
                <input id="register-email" type="email" placeholder="邮箱" class="w-full px-4 py-3 bg-[var(--md-sys-color-surface-container-highest)] rounded-xl border-2 border-transparent focus:border-[var(--md-sys-color-tertiary)] focus:outline-none transition">
                <input id="register-password" type="password" placeholder="密码 (至少6位)" class="w-full px-4 py-3 bg-[var(--md-sys-color-surface-container-highest)] rounded-xl border-2 border-transparent focus:border-[var(--md-sys-color-tertiary)] focus:outline-none transition">
            </div>
            <div>
                <button onclick="handleRegister()" class="w-full bg-[var(--md-sys-color-tertiary)] text-[var(--md-sys-color-on-tertiary)] py-3 rounded-full font-bold text-lg shadow-lg hover:bg-pink-700 transition-transform transform hover:scale-105">
                    注册
                </button>
            </div>
            <p class="text-center text-sm text-[var(--md-sys-color-on-surface-variant)]">
                已经有账户了? <a href="#" onclick="showView('login-view')" class="font-medium text-[var(--md-sys-color-tertiary)] hover:text-pink-700">返回登录</a>
            </p>
        </div>
    </div>

    <!-- 忘记密码视图 -->
    <div id="forgot-password-view" class="view h-full w-full flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-[var(--md-sys-color-surface)] p-8 rounded-3xl shadow-2xl space-y-6">
            <div class="text-center">
                <span class="material-symbols-outlined text-6xl text-[var(--md-sys-color-secondary)]">lock_reset</span>
                <h1 class="text-3xl font-bold text-[var(--md-sys-color-on-surface)] mt-2">重置密码</h1>
                <p class="text-[var(--md-sys-color-on-surface-variant)]">我们将发送一封邮件来重置您的密码</p>
            </div>
            <div id="forgot-message" class="hidden p-3 rounded-lg text-sm"></div>
            <div class="space-y-4">
                <input id="forgot-email" type="email" placeholder="输入您的注册邮箱" class="w-full px-4 py-3 bg-[var(--md-sys-color-surface-container-highest)] rounded-xl border-2 border-transparent focus:border-[var(--md-sys-color-secondary)] focus:outline-none transition">
            </div>
            <div>
                <button onclick="handleForgotPassword()" class="w-full bg-[var(--md-sys-color-secondary)] text-[var(--md-sys-color-on-secondary)] py-3 rounded-full font-bold text-lg shadow-lg hover:bg-purple-800 transition-transform transform hover:scale-105">
                    发送重置邮件
                </button>
            </div>
            <p class="text-center text-sm">
                <a href="#" onclick="showView('login-view')" class="font-medium text-[var(--md-sys-color-secondary)] hover:text-purple-800">返回登录</a>
            </p>
        </div>
    </div>

    <!-- 聊天主视图 -->
    <div id="chat-view" class="view h-screen w-screen flex hidden">
        <div id="chat-overlay" onclick="toggleSidebar()"></div>
        <!-- 侧边栏 -->
        <aside class="chat-sidebar w-full md:w-1/3 lg:w-1/4 bg-[var(--md-sys-color-surface-container-highest)] flex flex-col h-full border-r border-[var(--md-sys-color-surface-variant)]">
            <!-- 侧边栏头部 -->
            <header class="p-4 border-b border-[var(--md-sys-color-surface-variant)] flex items-center justify-between">
                <div class="flex items-center gap-3 cursor-pointer" onclick="openModal('profile-modal')">
                    <img id="sidebar-avatar" src="https://placehold.co/40x40/EADDFF/21005D?text=U" class="w-10 h-10 rounded-full object-cover">
                    <span id="sidebar-username" class="font-bold text-lg text-[var(--md-sys-color-on-surface)]">...</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openModal('add-friend-modal')" class="p-2 rounded-full hover:bg-[var(--md-sys-color-surface-variant)]" title="添加好友">
                        <span class="material-symbols-outlined text-[var(--md-sys-color-on-surface-variant)]">person_add</span>
                    </button>
                    <button onclick="openModal('requests-modal')" class="p-2 rounded-full hover:bg-[var(--md-sys-color-surface-variant)] relative" title="好友申请">
                        <span class="material-symbols-outlined text-[var(--md-sys-color-on-surface-variant)]">notifications</span>
                        <span id="requests-badge" class="absolute top-0 right-0 w-4 h-4 bg-[var(--md-sys-color-tertiary)] text-white text-xs rounded-full flex items-center justify-center hidden"></span>
                    </button>
                    <button onclick="handleLogout()" class="p-2 rounded-full hover:bg-[var(--md-sys-color-surface-variant)]" title="退出登录">
                        <span class="material-symbols-outlined text-[var(--md-sys-color-on-surface-variant)]">logout</span>
                    </button>
                </div>
            </header>
            <!-- 好友列表 -->
            <div id="friend-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- 好友条目将在这里动态生成 -->
            </div>
        </aside>

        <!-- 主聊天区 -->
        <main id="chat-main" class="chat-main flex-1 flex flex-col h-screen bg-[var(--md-sys-color-surface)]">
            <!-- 欢迎界面 -->
            <div id="welcome-screen" class="flex-1 flex flex-col items-center justify-center text-center p-8">
                <span class="material-symbols-outlined text-9xl text-[var(--md-sys-color-primary-container)]">forum</span>
                <h2 class="mt-4 text-3xl font-bold text-[var(--md-sys-color-on-surface)]">开始聊天吧！</h2>
                <p class="mt-2 text-lg text-[var(--md-sys-color-on-surface-variant)]">从左侧选择一位好友开始对话，<br>或添加新好友来扩展你的圈子。</p>
            </div>
            <!-- 聊天窗口 -->
            <div id="chat-window" class="hidden flex-1 flex flex-col">
                <!-- 聊天窗口头部 -->
                <header class="p-4 border-b border-[var(--md-sys-color-surface-variant)] flex items-center gap-4">
                    <button class="md:hidden p-2 rounded-full hover:bg-[var(--md-sys-color-surface-variant)]" onclick="toggleSidebar()">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <img id="chat-header-avatar" src="https://placehold.co/40x40/EADDFF/21005D?text=F" class="w-10 h-10 rounded-full object-cover cursor-pointer" onclick="openModal('friend-profile-modal')">
                    <div>
                        <h3 id="chat-header-username" class="font-bold text-lg text-[var(--md-sys-color-on-surface)] cursor-pointer" onclick="openModal('friend-profile-modal')">好友名称</h3>
                        <p id="chat-header-status" class="text-sm text-green-500">在线</p>
                    </div>
                </header>
                <!-- 消息区域 -->
                <div id="message-list" class="flex-1 p-4 overflow-y-auto space-y-4">
                    <!-- 消息将在这里动态生成 -->
                </div>
                <!-- 消息输入区 -->
                <footer class="p-4 bg-[var(--md-sys-color-surface-container-highest)]">
                    <div class="flex items-center gap-4">
                        <input id="message-input" type="text" placeholder="输入消息..." class="flex-1 px-4 py-3 bg-[var(--md-sys-color-surface)] rounded-full border-2 border-transparent focus:border-[var(--md-sys-color-primary)] focus:outline-none transition">
                        <button id="send-button" onclick="sendMessage()" class="bg-[var(--md-sys-color-primary)] text-[var(--md-sys-color-on-primary)] rounded-full p-3 shadow-lg hover:bg-[var(--md-sys-color-secondary)] transition-transform transform hover:scale-110">
                            <span class="material-symbols-outlined">send</span>
                        </button>
                    </div>
                </footer>
            </div>
        </main>
    </div>

    <!-- 模态框容器 -->
    <div id="modal-container">
        <!-- 个人资料模态框 -->
        <div id="profile-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" onclick="closeModal('profile-modal', event)">
            <div class="bg-[var(--md-sys-color-surface)] rounded-3xl shadow-2xl w-full max-w-md p-6 space-y-4 relative animate-in zoom-in-90">
                <button onclick="closeModal('profile-modal')" class="absolute top-4 right-4 p-2 rounded-full hover:bg-[var(--md-sys-color-surface-variant)]">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <h2 class="text-2xl font-bold text-center">我的资料</h2>
                <div class="flex flex-col items-center space-y-4">
                    <div class="relative">
                        <img id="profile-modal-avatar" src="https://placehold.co/128x128/EADDFF/21005D?text=U" class="w-32 h-32 rounded-full object-cover border-4 border-[var(--md-sys-color-primary-container)]">
                        <label for="avatar-upload" class="absolute bottom-0 right-0 bg-[var(--md-sys-color-primary)] text-white p-2 rounded-full cursor-pointer hover:bg-[var(--md-sys-color-secondary)] transition">
                            <span class="material-symbols-outlined">photo_camera</span>
                        </label>
                        <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
                    </div>
                </div>
                <div class="space-y-2">
                    <label for="profile-username" class="text-sm font-medium text-[var(--md-sys-color-on-surface-variant)]">用户名</label>
                    <input id="profile-username" type="text" class="w-full px-4 py-2 bg-[var(--md-sys-color-surface-container-highest)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--md-sys-color-primary)]">
                    <label for="profile-bio" class="text-sm font-medium text-[var(--md-sys-color-on-surface-variant)]">自我介绍</label>
                    <textarea id="profile-bio" rows="3" class="w-full px-4 py-2 bg-[var(--md-sys-color-surface-container-highest)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--md-sys-color-primary)]"></textarea>
                </div>
                <button onclick="updateProfile()" class="w-full bg-[var(--md-sys-color-primary)] text-white py-3 rounded-full font-bold">保存更改</button>
            </div>
        </div>

        <!-- 好友资料模态框 -->
        <div id="friend-profile-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" onclick="closeModal('friend-profile-modal', event)">
            <div class="bg-[var(--md-sys-color-surface)] rounded-3xl shadow-2xl w-full max-w-md p-6 space-y-4 relative animate-in zoom-in-90">
                <button onclick="closeModal('friend-profile-modal')" class="absolute top-4 right-4 p-2 rounded-full hover:bg-[var(--md-sys-color-surface-variant)]">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <div class="flex flex-col items-center space-y-4">
                    <img id="friend-profile-avatar" src="https://placehold.co/128x128/EADDFF/21005D?text=F" class="w-32 h-32 rounded-full object-cover border-4 border-[var(--md-sys-color-primary-container)]">
                    <h2 id="friend-profile-username" class="text-3xl font-bold">好友名称</h2>
                    <p id="friend-profile-email" class="text-sm text-[var(--md-sys-color-on-surface-variant)]">friend@example.com</p>
                </div>
                <div class="bg-[var(--md-sys-color-surface-container-highest)] p-4 rounded-xl">
                    <h3 class="font-bold text-[var(--md-sys-color-on-surface-variant)]">自我介绍</h3>
                    <p id="friend-profile-bio" class="mt-1 text-[var(--md-sys-color-on-surface)]">这是好友的自我介绍。</p>
                </div>
            </div>
        </div>

        <!-- 添加好友模态框 -->
        <div id="add-friend-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" onclick="closeModal('add-friend-modal', event)">
            <div class="bg-[var(--md-sys-color-surface)] rounded-3xl shadow-2xl w-full max-w-md p-6 space-y-4 relative animate-in zoom-in-90">
                <button onclick="closeModal('add-friend-modal')" class="absolute top-4 right-4 p-2 rounded-full hover:bg-[var(--md-sys-color-surface-variant)]">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <h2 class="text-2xl font-bold text-center">添加好友</h2>
                <p class="text-center text-sm text-[var(--md-sys-color-on-surface-variant)]">通过邮箱地址发送好友申请</p>
                <div id="add-friend-message" class="hidden p-3 rounded-lg text-sm"></div>
                <input id="add-friend-email" type="email" placeholder="输入好友的邮箱" class="w-full px-4 py-3 bg-[var(--md-sys-color-surface-container-highest)] rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--md-sys-color-primary)]">
                <button onclick="sendFriendRequest()" class="w-full bg-[var(--md-sys-color-primary)] text-white py-3 rounded-full font-bold">发送申请</button>
            </div>
        </div>

        <!-- 好友申请模态框 -->
        <div id="requests-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" onclick="closeModal('requests-modal', event)">
            <div class="bg-[var(--md-sys-color-surface)] rounded-3xl shadow-2xl w-full max-w-md p-6 space-y-4 relative animate-in zoom-in-90 flex flex-col" style="max-height: 80vh;">
                <button onclick="closeModal('requests-modal')" class="absolute top-4 right-4 p-2 rounded-full hover:bg-[var(--md-sys-color-surface-variant)]">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <h2 class="text-2xl font-bold text-center">好友申请</h2>
                <div id="request-list" class="flex-1 overflow-y-auto space-y-3 pr-2">
                    <!-- 申请列表将在这里动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 全局变量和状态 ---
        let currentUser = null;
        let currentChatFriendId = null;
        let friendListUnsubscribe = null;
        let requestsUnsubscribe = null;
        let chatUnsubscribe = null;

        // --- DOM 元素 ---
        const loader = document.getElementById('loader');
        const views = {
            login: document.getElementById('login-view'),
            register: document.getElementById('register-view'),
            forgot: document.getElementById('forgot-password-view'),
            chat: document.getElementById('chat-view'),
        };

        // --- 视图管理 ---
        const showView = (viewId) => {
            loader.style.display = 'flex';
            Object.values(views).forEach(v => v.classList.add('hidden'));
            if (views[viewId]) {
                views[viewId].classList.remove('hidden');
            }
            // 短暂延迟以显示加载动画
            setTimeout(() => {
                loader.style.display = 'none';
            }, 300);
        };
        window.showView = showView; // 暴露给全局

        const openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
            if (modalId === 'friend-profile-modal') {
                loadFriendProfileIntoModal(currentChatFriendId);
            }
        };
        window.openModal = openModal;

        const closeModal = (modalId, event) => {
            const modal = document.getElementById(modalId);
            // 如果点击的是背景而不是内容，则关闭
            if (modal && (!event || event.target === modal)) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };
        window.closeModal = closeModal;
        
        const toggleSidebar = () => {
            document.querySelector('.chat-sidebar').classList.toggle('open');
            document.getElementById('chat-overlay').classList.toggle('open');
        }
        window.toggleSidebar = toggleSidebar;

        // --- 错误/消息处理 ---
        const showMessage = (elementId, message, isError = true) => {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden');
            if (isError) {
                el.classList.add('text-red-500', 'bg-red-100');
                el.classList.remove('text-green-700', 'bg-green-100');
            } else {
                el.classList.remove('text-red-500', 'bg-red-100');
                el.classList.add('text-green-700', 'bg-green-100');
            }
        };

        // --- Firebase 核心逻辑 ---
        document.addEventListener('DOMContentLoaded', () => {
            const { auth, onAuthStateChanged } = window.firebase;
            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUser = user;
                    setupRealtimeListeners(user.uid);
                    loadUserProfile(user.uid);
                    showView('chat');
                } else {
                    currentUser = null;
                    cleanupListeners();
                    showView('login');
                }
            });
        });

        // --- 认证处理 ---
        const handleRegister = async () => {
            const { auth, createUserWithEmailAndPassword, doc, setDoc, db } = window.firebase;
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');

            if (!username || !email || password.length < 6) {
                showMessage('register-error', '请填写所有字段，密码至少6位。');
                return;
            }

            loader.style.display = 'flex';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // 创建用户资料
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    username: username,
                    email: email,
                    bio: "嗨，我来啦！",
                    avatar: "", // 初始为空
                    friends: []
                });
                // 注册成功后直接进入聊天界面
            } catch (error) {
                const message = error.code === 'auth/email-already-in-use' ? '该邮箱已被注册。' : '注册失败，请重试。';
                showMessage('register-error', message);
                loader.style.display = 'none';
            }
        };
        window.handleRegister = handleRegister;

        const handleLogin = async () => {
            const { auth, signInWithEmailAndPassword, setPersistence, browserLocalPersistence, browserSessionPersistence } = window.firebase;
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            if (!email || !password) {
                showMessage('login-error', '请输入邮箱和密码。');
                return;
            }

            loader.style.display = 'flex';
            try {
                const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged 会处理后续跳转
            } catch (error) {
                const message = (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential')
                    ? '邮箱或密码错误。'
                    : '登录失败，请重试。';
                showMessage('login-error', message);
                loader.style.display = 'none';
            }
        };
        window.handleLogin = handleLogin;

        const handleLogout = async () => {
            const { auth, signOut } = window.firebase;
            await signOut(auth);
            // onAuthStateChanged 会处理后续跳转
        };
        window.handleLogout = handleLogout;
        
        const handleForgotPassword = async () => {
            const { auth, sendPasswordResetEmail } = window.firebase;
            const email = document.getElementById('forgot-email').value.trim();
            const messageEl = document.getElementById('forgot-message');

            if (!email) {
                showMessage('forgot-message', '请输入您的邮箱地址。', true);
                return;
            }
            
            loader.style.display = 'flex';
            try {
                await sendPasswordResetEmail(auth, email);
                showMessage('forgot-message', '重置邮件已发送，请检查您的收件箱。', false);
            } catch (error) {
                showMessage('forgot-message', '发送失败，请检查邮箱地址是否正确。', true);
            } finally {
                loader.style.display = 'none';
            }
        };
        window.handleForgotPassword = handleForgotPassword;

        // --- 用户资料 ---
        const loadUserProfile = async (uid) => {
            const { db, doc, getDoc } = window.firebase;
            const userDoc = await getDoc(doc(db, "users", uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                // 侧边栏
                document.getElementById('sidebar-avatar').src = userData.avatar || `https://placehold.co/40x40/EADDFF/21005D?text=${userData.username.charAt(0).toUpperCase()}`;
                document.getElementById('sidebar-username').textContent = userData.username;
                // 个人资料模态框
                document.getElementById('profile-modal-avatar').src = userData.avatar || `https://placehold.co/128x128/EADDFF/21005D?text=${userData.username.charAt(0).toUpperCase()}`;
                document.getElementById('profile-username').value = userData.username;
                document.getElementById('profile-bio').value = userData.bio;
            }
        };
        
        const handleAvatarUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 256;
                    const MAX_HEIGHT = 256;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // 压缩并转换为 base64
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('profile-modal-avatar').src = dataUrl;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };
        window.handleAvatarUpload = handleAvatarUpload;

        const updateProfile = async () => {
            const { db, doc, setDoc } = window.firebase;
            const newUsername = document.getElementById('profile-username').value.trim();
            const newBio = document.getElementById('profile-bio').value.trim();
            const newAvatar = document.getElementById('profile-modal-avatar').src;

            if (!newUsername) {
                alert('用户名不能为空！');
                return;
            }
            
            loader.style.display = 'flex';
            try {
                await setDoc(doc(db, "users", currentUser.uid), {
                    username: newUsername,
                    bio: newBio,
                    avatar: newAvatar.startsWith('data:image') ? newAvatar : '',
                }, { merge: true });
                
                await loadUserProfile(currentUser.uid);
                closeModal('profile-modal');
            } catch (error) {
                console.error("更新资料失败: ", error);
                alert('更新失败，请重试。');
            } finally {
                loader.style.display = 'none';
            }
        };
        window.updateProfile = updateProfile;
        
        const loadFriendProfileIntoModal = async (friendId) => {
            if (!friendId) return;
            const { db, doc, getDoc } = window.firebase;
            const userDoc = await getDoc(doc(db, "users", friendId));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                document.getElementById('friend-profile-avatar').src = userData.avatar || `https://placehold.co/128x128/EADDFF/21005D?text=${userData.username.charAt(0).toUpperCase()}`;
                document.getElementById('friend-profile-username').textContent = userData.username;
                document.getElementById('friend-profile-email').textContent = userData.email;
                document.getElementById('friend-profile-bio').textContent = userData.bio || '对方很神秘，什么也没留下。';
            }
        }

        // --- 好友系统 ---
        const sendFriendRequest = async () => {
            const { db, collection, query, where, getDocs, addDoc, doc, getDoc } = window.firebase;
            const email = document.getElementById('add-friend-email').value.trim();
            const messageEl = document.getElementById('add-friend-message');

            if (email === currentUser.email) {
                showMessage('add-friend-message', '不能添加自己为好友。');
                return;
            }

            loader.style.display = 'flex';
            try {
                // 1. 查找用户
                const q = query(collection(db, "users"), where("email", "==", email));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showMessage('add-friend-message', '未找到该用户。');
                    return;
                }
                
                const friendData = querySnapshot.docs[0].data();
                const friendId = friendData.uid;

                // 2. 检查是否已经是好友
                const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
                if (currentUserDoc.data().friends.includes(friendId)) {
                    showMessage('add-friend-message', '你们已经是好友了。', false);
                    return;
                }

                // 3. 检查是否已发送过请求
                const qRequest = query(collection(db, "friendRequests"), 
                    where("from", "==", currentUser.uid), 
                    where("to", "==", friendId));
                const requestSnapshot = await getDocs(qRequest);
                if (!requestSnapshot.empty) {
                    showMessage('add-friend-message', '您已发送过请求，请耐心等待。', false);
                    return;
                }

                // 4. 发送请求
                await addDoc(collection(db, "friendRequests"), {
                    from: currentUser.uid,
                    to: friendId,
                    status: "pending",
                    fromUsername: document.getElementById('sidebar-username').textContent,
                    fromAvatar: document.getElementById('sidebar-avatar').src
                });
                showMessage('add-friend-message', '好友申请已发送！', false);
                document.getElementById('add-friend-email').value = '';

            } catch (error) {
                console.error("发送好友申请失败: ", error);
                showMessage('add-friend-message', '发送失败，请重试。');
            } finally {
                loader.style.display = 'none';
            }
        };
        window.sendFriendRequest = sendFriendRequest;

        const handleFriendRequest = async (requestId, fromId, toId, accept) => {
            const { db, doc, setDoc, getDoc } = window.firebase;
            loader.style.display = 'flex';
            try {
                if (accept) {
                    // 更新双方好友列表
                    const userRef = doc(db, "users", toId);
                    const friendRef = doc(db, "users", fromId);
                    const userDoc = await getDoc(userRef);
                    const friendDoc = await getDoc(friendRef);
                    
                    const userFriends = userDoc.data().friends || [];
                    const friendFriends = friendDoc.data().friends || [];

                    await setDoc(userRef, { friends: [...userFriends, fromId] }, { merge: true });
                    await setDoc(friendRef, { friends: [...friendFriends, toId] }, { merge: true });
                }
                // 更新请求状态
                await setDoc(doc(db, "friendRequests", requestId), { status: accept ? 'accepted' : 'declined' }, { merge: true });
                // 重新加载申请列表
            } catch (error) {
                console.error("处理好友申请失败: ", error);
                alert('操作失败，请重试。');
            } finally {
                loader.style.display = 'none';
            }
        };
        window.handleFriendRequest = handleFriendRequest;


        // --- 实时监听器 ---
        const setupRealtimeListeners = (uid) => {
            const { db, collection, query, where, onSnapshot, doc } = window.firebase;
            
            // 监听好友列表
            friendListUnsubscribe = onSnapshot(doc(db, "users", uid), async (doc) => {
                if (doc.exists()) {
                    const friendIds = doc.data().friends || [];
                    renderFriendList(friendIds);
                }
            });

            // 监听好友申请
            const q = query(collection(db, "friendRequests"), where("to", "==", uid), where("status", "==", "pending"));
            requestsUnsubscribe = onSnapshot(q, (snapshot) => {
                const requests = [];
                snapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                renderRequestList(requests);
                
                const badge = document.getElementById('requests-badge');
                if (requests.length > 0) {
                    badge.textContent = requests.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            });
        };

        const cleanupListeners = () => {
            if (friendListUnsubscribe) friendListUnsubscribe();
            if (requestsUnsubscribe) requestsUnsubscribe();
            if (chatUnsubscribe) chatUnsubscribe();
        };

        // --- UI 渲染 ---
        const renderFriendList = async (friendIds) => {
            const { db, doc, getDoc } = window.firebase;
            const friendListEl = document.getElementById('friend-list');
            friendListEl.innerHTML = '';
            if (friendIds.length === 0) {
                friendListEl.innerHTML = `<p class="p-4 text-center text-sm text-[var(--md-sys-color-on-surface-variant)]">还没有好友，快去添加吧！</p>`;
                return;
            }
            
            for (const id of friendIds) {
                const userDoc = await getDoc(doc(db, "users", id));
                if (userDoc.exists()) {
                    const friend = userDoc.data();
                    const friendEl = document.createElement('div');
                    friendEl.className = `flex items-center gap-4 p-3 rounded-2xl cursor-pointer hover:bg-[var(--md-sys-color-surface-variant)] transition`;
                    friendEl.onclick = () => openChat(friend.uid);
                    friendEl.innerHTML = `
                        <img src="${friend.avatar || `https://placehold.co/48x48/EADDFF/21005D?text=${friend.username.charAt(0).toUpperCase()}`}" class="w-12 h-12 rounded-full object-cover">
                        <div class="flex-1">
                            <p class="font-bold text-[var(--md-sys-color-on-surface)]">${friend.username}</p>
                            <p class="text-sm text-[var(--md-sys-color-on-surface-variant)] truncate">最近消息...</p>
                        </div>
                    `;
                    friendListEl.appendChild(friendEl);
                }
            }
        };
        
        const renderRequestList = (requests) => {
            const requestListEl = document.getElementById('request-list');
            requestListEl.innerHTML = '';
            if (requests.length === 0) {
                requestListEl.innerHTML = `<p class="p-4 text-center text-sm text-[var(--md-sys-color-on-surface-variant)]">没有新的好友申请</p>`;
                return;
            }
            requests.forEach(req => {
                const reqEl = document.createElement('div');
                reqEl.className = 'flex items-center justify-between p-3 bg-[var(--md-sys-color-surface-container-highest)] rounded-xl';
                reqEl.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${req.fromAvatar || `https://placehold.co/40x40/EADDFF/21005D?text=${req.fromUsername.charAt(0).toUpperCase()}`}" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <p class="font-semibold">${req.fromUsername}</p>
                            <p class="text-xs text-[var(--md-sys-color-on-surface-variant)]">请求添加你为好友</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="handleFriendRequest('${req.id}', '${req.from}', '${req.to}', true)" class="bg-green-500 text-white px-3 py-1 text-sm rounded-full font-semibold">同意</button>
                        <button onclick="handleFriendRequest('${req.id}', '${req.from}', '${req.to}', false)" class="bg-gray-300 px-3 py-1 text-sm rounded-full font-semibold">拒绝</button>
                    </div>
                `;
                requestListEl.appendChild(reqEl);
            });
        };

        // --- 聊天逻辑 ---
        const openChat = async (friendId) => {
            if (currentChatFriendId === friendId) return;

            const { db, doc, getDoc, collection, query, orderBy, onSnapshot } = window.firebase;
            currentChatFriendId = friendId;
            
            // 在移动端关闭侧边栏
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }

            // 清理旧的聊天监听器
            if (chatUnsubscribe) chatUnsubscribe();

            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('chat-window').classList.remove('hidden');
            document.getElementById('chat-window').classList.add('flex');
            
            // 加载好友信息到头部
            const friendDoc = await getDoc(doc(db, "users", friendId));
            if (friendDoc.exists()) {
                const friendData = friendDoc.data();
                document.getElementById('chat-header-avatar').src = friendData.avatar || `https://placehold.co/40x40/EADDFF/21005D?text=${friendData.username.charAt(0).toUpperCase()}`;
                document.getElementById('chat-header-username').textContent = friendData.username;
            }

            // 设置新的聊天监听器
            const chatId = [currentUser.uid, friendId].sort().join('_');
            const messagesRef = collection(db, "chats", chatId, "messages");
            const q = query(messagesRef, orderBy("timestamp", "asc"));

            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                const messageListEl = document.getElementById('message-list');
                messageListEl.innerHTML = '';
                snapshot.forEach(doc => {
                    renderMessage(doc.data());
                });
                // 滚动到底部
                messageListEl.scrollTop = messageListEl.scrollHeight;
            });
        };
        window.openChat = openChat;

        const renderMessage = (msg) => {
            const messageListEl = document.getElementById('message-list');
            const isMe = msg.senderId === currentUser.uid;
            
            const msgWrapper = document.createElement('div');
            msgWrapper.className = `flex items-end gap-2 ${isMe ? 'justify-end' : 'justify-start'}`;
            
            const msgBubble = document.createElement('div');
            msgBubble.className = `max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 rounded-2xl ${isMe ? 'bg-[var(--md-sys-color-primary)] text-white rounded-br-none' : 'bg-[var(--md-sys-color-surface-variant)] text-[var(--md-sys-color-on-surface-variant)] rounded-bl-none'}`;
            msgBubble.textContent = msg.text;

            msgWrapper.appendChild(msgBubble);
            messageListEl.appendChild(msgWrapper);
        };
        
        const sendMessage = async () => {
            const { db, collection, addDoc, serverTimestamp } = window.firebase;
            const input = document.getElementById('message-input');
            const text = input.value.trim();

            if (!text || !currentChatFriendId) return;

            const chatId = [currentUser.uid, currentChatFriendId].sort().join('_');
            const messagesRef = collection(db, "chats", chatId, "messages");
            
            try {
                await addDoc(messagesRef, {
                    text: text,
                    senderId: currentUser.uid,
                    receiverId: currentChatFriendId,
                    timestamp: serverTimestamp()
                });
                input.value = '';
                input.focus();
            } catch (error) {
                console.error("发送消息失败: ", error);
                alert('消息发送失败，请重试。');
            }
        };
        window.sendMessage = sendMessage;

        // 监听回车键发送消息
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

    </script>
</body>
</html>
